
#
# Testing preserve_foreing_keys in cycle/loop scenarios
#


--disable_warnings
drop table if exists t1,t2,t3,_vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_,_vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_;
--enable_warnings

--echo # Simple two table setup
# t1->t2
# Adding t2->t1
create table t1 (id int primary key, i int, key(i), data int);
create table t2 (id int primary key, i int, key(i), data int);
insert into t1 values (1, 2, 10);
insert into t2 values (2, 1, 20);
ALTER TABLE t1 ADD CONSTRAINT t1t2fk FOREIGN KEY (i) REFERENCES t2 (id);
create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ like t2;
ALTER TABLE _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2t1fk FOREIGN KEY (i) REFERENCES t1 (id);
insert into _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ select * from t2;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
--error ER_ROW_IS_REFERENCED_2
delete from t1;
--error ER_ROW_IS_REFERENCED_2
delete from t2;
update t2 set i=null;
delete from t1;
show create table t1;
show create table t2;
show create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;

--echo # Three table setup
# t1->t2->t3
# Adding t2->t1
--disable_warnings
drop table if exists t1,t2,t3,_vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_,_vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_;
--enable_warnings
create table t1 (id int primary key, i int, key(i), data int);
create table t2 (id int primary key, i int, key(i), i3 int, key (i3), data int);
create table t3 (id int primary key, i int, key(i), data int);
insert into t1 values (1, 2, 10);
insert into t2 values (2, 1, 3, 20);
insert into t3 values (3, 3, 30);
ALTER TABLE t1 ADD CONSTRAINT t1t2fk FOREIGN KEY (i) REFERENCES t2 (id);
ALTER TABLE t2 ADD CONSTRAINT t2t3fk FOREIGN KEY (i3) REFERENCES t3 (id);
create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ like t2;
alter table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2bt3fk FOREIGN KEY (i3) REFERENCES t3 (id);
ALTER TABLE _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2t1fk FOREIGN KEY (i) REFERENCES t1 (id);
insert into _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ select * from t2;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
--error ER_ROW_IS_REFERENCED_2
delete from t1;
--error ER_ROW_IS_REFERENCED_2
delete from t2;
--error ER_ROW_IS_REFERENCED_2
delete from t3;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
show create table t1;
show create table t2;
show create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
# Following insert is fine because of internal table name
insert into _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ values (111, 111, 333, 222);
update t2 set i3=null;
delete from t3;
# The following attempts to fail an assertion in `dict0dict.cc`, see:
# > /* Look for a table with the same id: error if such exists */
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;

--echo # Three table cycle
# t3->t1->t2
# Adding t2->t3 (end result: t3->t1->t2->t3)
--disable_warnings
drop table if exists t1,t2,t3,_vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_,_vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_;
--enable_warnings
create table t1 (id int primary key, i int, key(i), data int);
create table t2 (id int primary key, i int, key(i), data int);
create table t3 (id int primary key, i int, key(i), data int);
insert into t1 values (1, 2, 10);
insert into t2 values (2, 3, 20);
insert into t3 values (3, 1, 30);
ALTER TABLE t1 ADD CONSTRAINT t1t2fk FOREIGN KEY (i) REFERENCES t2 (id);
ALTER TABLE t3 ADD CONSTRAINT t3t1fk FOREIGN KEY (i) REFERENCES t1 (id);
create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ like t2;
ALTER TABLE _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2t3fk FOREIGN KEY (i) REFERENCES t3 (id);
insert into _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ select * from t2;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
--error ER_ROW_IS_REFERENCED_2
delete from t1;
--error ER_ROW_IS_REFERENCED_2
delete from t2;
--error ER_ROW_IS_REFERENCED_2
delete from t3;
show create table t1;
show create table t2;
show create table t3;
show create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;

--echo # two cycles
# t1<->t2<->t3
# modifying t2 to add some arbitrary new column
--disable_warnings
drop table if exists t1,t2,t3,_vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_,_vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_;
--enable_warnings
create table t1 (id int primary key, i2 int, key(i2), data int);
create table t2 (id int primary key, i1 int, key(i1), i3 int, key (i3), data int);
create table t3 (id int primary key, i2 int, key(i2), data int);
insert into t1 values (1, 2, 10);
insert into t2 values (2, 1, 3, 20);
insert into t3 values (3, 2, 30);
ALTER TABLE t1 ADD CONSTRAINT t1t2fk FOREIGN KEY (i2) REFERENCES t2 (id);
ALTER TABLE t2 ADD CONSTRAINT t2t1fk FOREIGN KEY (i1) REFERENCES t1 (id);
ALTER TABLE t2 ADD CONSTRAINT t2t3fk FOREIGN KEY (i3) REFERENCES t3 (id);
ALTER TABLE t3 ADD CONSTRAINT t3t2fk FOREIGN KEY (i2) REFERENCES t2 (id);
create table _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ like t2;
ALTER TABLE _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2bt1fk FOREIGN KEY (i1) REFERENCES t1 (id);
ALTER TABLE _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ ADD CONSTRAINT t2tb3fk FOREIGN KEY (i3) REFERENCES t3 (id);
insert into _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ select * from t2;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
# The following attempts to fail an assertion in `dict0dict.cc`, see:
# > /* Look for a table with the same id: error if such exists */
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
select * from t1;
select * from t2;
select * from t3;
select * from _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;
rename table t2 to _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_, _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_ to t2, _vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_ to _vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_;

--echo # Cleanup
--disable_warnings
drop table if exists t1,t2,t3,_vt_vrp_7dc2886cfd4911eea2770a43f95f28a3_20240418060418_,_vt_hld_811ad1fcfd4911eeb0f60a43f95f28a3_20240419060423_;
--enable_warnings
