DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS `t3"`;
DROP TABLE IF EXISTS `t4_partitioned`;
DROP TABLE IF EXISTS `t5`;
DROP TABLE IF EXISTS `₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤`;

CREATE TABLE t1 (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `a` bigint NOT NULL,
  `b` bigint NOT NULL,
  `c` bigint NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_a` (`a`),
  KEY `idx_a_b` (`a`,`b`),
  KEY `idx_b` (`b`)
);
INSERT INTO `t1` VALUES (1,2,3,4),(2,1,4,5),(3,2,5,6),(4,1,6,7),(5,2,7,8),(6,1,8,9),(7,2,9,10),(8,1,10,11),(9,2,11,12),(10,1,12,13); 

CREATE TABLE t2 (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `t1_id` bigint NOT NULL,
  `a` bigint NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_a` (`a`)
);
INSERT INTO `t2` VALUES (1,1,1),(2,2,2),(3,3,3),(4,4,4),(5,5,5),(6,6,6),(7,7,7),(8,8,8),(9,9,9),(10,10,10),(11,11,11),(12,12,12),(13,13,13),(14,14,14),(15,15,15),(16,16,16),(17,17,17),(18,18,18),(19,19,19),(20,20,20),(21,21,21),(22,22,22),(23,23,23),(24,24,24),(25,25,25);


CREATE TABLE `t3"` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `a` bigint NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx"` (`a`)
);

CREATE TABLE `t4_partitioned` (
  `id` bigint NOT NULL,
  `a` bigint NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_a` (`a`)
)
PARTITION BY RANGE (`id`) (
  PARTITION partition_u100 VALUES LESS THAN (100),
  PARTITION partition_umax VALUES LESS THAN MAXVALUE
);

CREATE TABLE `t5` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `a` bigint NOT NULL,
  `b` bigint NOT NULL,
  `c` bigint NOT NULL,
  `d` bigint NOT NULL,
  `e` bigint NOT NULL,
  `f` bigint NOT NULL,
  `g` bigint NOT NULL,
  `h` bigint NOT NULL,
  `i` bigint NOT NULL,
  `j` bigint NOT NULL,
  PRIMARY KEY (`id`),
  KEY `aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa` (`a`),
  KEY `bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb` (`b`),
  KEY `cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc` (`c`),
  KEY `dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd` (`d`),
  KEY `eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee` (`e`),
  KEY `ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff` (`f`),
  KEY `gggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg` (`g`),
  KEY `hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh` (`h`),
  KEY `iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii` (`i`),
  KEY `jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj` (`j`)
);

CREATE TABLE `₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `a` bigint NOT NULL,
  `b` bigint NOT NULL,
  `c` bigint NOT NULL,
  `d` bigint NOT NULL,
  `e` bigint NOT NULL,
  `f` bigint NOT NULL,
  `g` bigint NOT NULL,
  `h` bigint NOT NULL,
  `i` bigint NOT NULL,
  `j` bigint NOT NULL,

  PRIMARY KEY (`id`),
  KEY `a₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`a`),
  KEY `b₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`b`),
  KEY `c₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`c`),
  KEY `d₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`d`),
  KEY `e₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`e`),
  KEY `f₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`f`),
  KEY `g₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`g`),
  KEY `h₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`h`),
  KEY `i₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`i`),
  KEY `j₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤` (`j`)
);

--echo Table scan
--exec MYSQL_METRICS=1 $MYSQL -e 'select count(*) from test.t1;'

--echo Primary key
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where id = 0;'

--echo Secondary key
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where a = 0;'

--echo Primary key OR secondary key
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where id = 0 or b = 0;'

--echo Composite secondary key
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where a = 1 and b = 0;'

--echo Unindexed column
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where c = 0;'

--echo Covering index
--exec MYSQL_METRICS=1 $MYSQL -e 'select a, b from test.t1 where a = 1 and b = 0;'

--echo Join
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 inner join test.t2 on test.t1.id = test.t2.t1_id where test.t1.id = 1 and test.t2.a = 0;'

--echo Union
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where a = 0 union select * from test.t1 where b = 0;'

--echo Doesn't send the same index twice
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t1 where a = 0 union select * from test.t1 where a = 0;'

--echo JSON Escaping
--exec MYSQL_METRICS=1 $MYSQL -e 'select id from test.`t3"` where a = 0;'

--echo Partitioned tables
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t4_partitioned where id = 0 or a = 0;'

--echo No insights metrics (no rows read or indexes used)
--exec MYSQL_METRICS=1 $MYSQL -e 'select 1;'

--echo Long insights message (used to overflow net_send_ok buffer)
--exec MYSQL_METRICS=1 $MYSQL -e 'select * from test.t5 where a = 1 union select * from test.t5 where b = 1 union select * from test.t5 where c = 1 union select * from test.t5 where d = 1 union select * from test.t5 where e = 1 union select * from test.t5 where f = 1 union select * from test.t5 where g = 1 union select * from test.t5 where h = 1 union select * from test.t5 where i = 1 union select * from test.t5 where j = 1;'

--echo Stops adding indexes after insights message reaches 2000 bytes
--exec MYSQL_METRICS=1 $MYSQL -e 'with t as (select * from test.`₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤`) select * from t where a = 1 union select * from t where b = 1 union select * from t where c = 1 union select * from t where d = 1 union select * from t where e = 1 union select * from t where f = 1 union select * from t where g = 1 union select * from t where h = 1 union select * from t where i = 1 union select * from t where j = 1 ;'

--echo Does not include indexes from temporary tables (otherwise we get indexes that look like: ["mysqld?1","#sql708_18_0","<auto_key0>"]
--exec MYSQL_METRICS=1 $MYSQL -e 'set big_tables=1; with qn as (select * from test.t1 limit 2) select (select max(a) from qn where qn.a=1);'

DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS `t3"`;
DROP TABLE IF EXISTS `t4_partitioned`;
DROP TABLE IF EXISTS t5;
DROP TABLE IF EXISTS `₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤₤`;
